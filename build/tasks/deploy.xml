<project>
	<property name="sync.options" value="avzcu" />
	<property name="sync.source" value="${project.basedir}/" />
	
	<target name="update-revision-hash" description="update git revision hash and revision count in config/git.revision">
		<echo msg="Putting current git revision hash into git.revision" />
		<exec escape="false" checkreturn="true" passthru="false" command="git rev-list HEAD | head -n 1 > config/git.revision" />
	</target>
	<target name="tag">
		<echo msg="tagging release with release-${date}" />
		<exec escape="false" checkreturn="true" passthru="false" command="git tag release-${date}" />
	</target>
	
	<target name="deploy-list" description="list files that would be deployed">
		<phingcall target="deploy">
			<property name="sync.options" value="${sync.options}n" />
		</phingcall>
	</target>
	
	<target name="deploy-fw">
		<echo>Deploying ephFrame version to server</echo>
		<exec escape="false" passthru="true" command="/Users/ephigenia/Sites/ephFrame/deploy_03.sh" />
	</target>
	
	<target name="deploy-test" description="deploy to target: test">
		<phingcall target="deploy">
			<property name="environment" value="test" />
		</phingcall>
	</target>
	
	<target name="deploy-ftp">
		<property name="ftp.port" value="21" />
		<property name="ftp.dir" value="/" />
		<fail unless="ftp.host" message="ftp.host missing" />
		<fail unless="ftp.user" message="ftp.user missing" />
		<fail unless="ftp.pass" message="ftp.pass missing" />
		<echo msg="FTP Deploy" />
		<echo msg="----------" />
		<echo msg="From:    ${deploy.fileset.refid}" />
		<echo msg="To:      ftp://${ftp.user}:****@${ftp.host}:${ftp.port}/${ftp.dir}" />
		<ftpdeploy
			host="${ftp.host}" port="${ftp.port}"
			username="${ftp.user}" password="${ftp.pass}"
			dir="${ftp.dir}"
			level="verbose">
			<fileset refid="${deploy.fileset.refid}" />
		</ftpdeploy>
		<echo msg="done" />
	</target>
	
	<target name="deploy-rsync">
		<fail unless="sync.options" message="No rsync options defined" />
		<property name="sync.target" value="${deploy.${environment}.target}" />
		<property name="sync.source" value="${deploy.${environment}.source}" />
		<property name="sync.extra" value="${deploy.${environment}.extra}" />
		<!-- confirm when not in list mode -->
		<if>
			<not><contains string="${sync.options}" substring="n" /></not>
			<then>
				<fail unless="sync.target" message="No rsync target specified" />
				<echo msg="RSync Deploy" />
				<echo msg="------------" />
				<echo msg="From:   ${sync.source}" />
				<echo msg="To:     ${sync.target}" />
			</then>
		</if>
		<property name="sync.command" value="rsync -${sync.options} --progress --cvs-exclude ${sync.extra} ${sync.source} -e ssh ${sync.target}" />
		<exec
			escape="false"
			checkreturn="true"
			passthru="true"
			command="${sync.command}"
		/>
	</target>
	
	<target name="deploy" depends="tag,update-revision-hash" description="deploy everything to live server">
		<property name="environment" value="test" />
		<phingcall target="config">
			<property name="environment" value="${environment}" />
		</phingcall>
		<phingcall target="deploy-rsync" />
		<phingcall target="config">
			<property name="environment" value="local" override="true" />
		</phingcall>
	</target>
</project>